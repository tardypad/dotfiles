#! /usr/bin/env zsh

IS_ADAPTER_ON=$( cat /sys/class/power_supply/AC/online )
IS_ANY_BATTERY_CHARGING=0
TOTAL_ENERGY_NOW=0
TOTAL_ENERGY_FULL=0

foreach bat in /sys/class/power_supply/BAT*; do
  (( TOTAL_ENERGY_NOW += $( cat $bat/energy_now ) ))
  (( TOTAL_ENERGY_FULL += $( cat $bat/energy_full ) ))

  if [[ $( cat $bat/status ) == 'Charging' ]]; then
    IS_ANY_BATTERY_CHARGING=1
  fi
done


TOTAL_ENERGY_PERCENT=$(
  printf %.0f $(
    echo "( ${TOTAL_ENERGY_NOW} / ${TOTAL_ENERGY_FULL} ) * 100" \
      | bc -l
  )
)

if [[ "${TOTAL_ENERGY_PERCENT}" -lt 10 ]]; then
  BATTERY_ICON=''
elif [[ "${TOTAL_ENERGY_PERCENT}" -lt 40 ]]; then
  BATTERY_ICON=''
elif [[ "${TOTAL_ENERGY_PERCENT}" -lt 60 ]]; then
  BATTERY_ICON=''
elif [[ "${TOTAL_ENERGY_PERCENT}" -lt 90 ]]; then
  BATTERY_ICON=''
else
  BATTERY_ICON=''
fi

if [[ "${IS_ADAPTER_ON}" -eq 1 ]]; then
  if [[ "${IS_ANY_BATTERY_CHARGING}" -eq 1 ]]; then
    echo "<span foreground='#{{{base0C/hex}}}'> ${BATTERY_ICON}</span> ${TOTAL_ENERGY_PERCENT}%"
  else
    echo "<span foreground='#{{{base0C/hex}}}'></span> AC"
  fi
else
  if [[ "${TOTAL_ENERGY_PERCENT}" -lt 10 ]]; then
    echo "<span foreground='#{{{base16/danger/hex}}}'>${BATTERY_ICON} ${TOTAL_ENERGY_PERCENT}%</span>"
    notify_low_battery
    exit 33
  else
    echo "<span foreground='#{{{base0C/hex}}}'>${BATTERY_ICON}</span> ${TOTAL_ENERGY_PERCENT}%"
  fi
fi
