#!/bin/sh

init_variables() {
  COMMAND=${0##*/}

  ENV_DIR_PATH="${XDG_CONFIG_HOME:-$HOME/.config}/redis/env"

  REDIS_OPTIONS=
  PROJECT=
  QUERY=

  ENV_PATH=
}

usage() {
  cat <<- EOF
	usage: ${COMMAND} [<options>] project [query]

	Start Redis or run a query within a project environment

	Options:
	  -h,  --help    show this message only

	  All available redis-cli options can be used there too
	  using an = for the ones needing a parameter (space not supported)
	EOF
}

error() {
  [ -z "$1" ] || echo "${COMMAND}: $1"
  echo "Try '${COMMAND} --help' for more information."
  exit 1
} >&2

run_redis() {
  if [ -z "${QUERY}" ]; then
    redis-cli $( cat "${ENV_PATH}" ) ${REDIS_OPTIONS}
  else
    redis-cli $( cat "${ENV_PATH}" ) --raw ${REDIS_OPTIONS} ${QUERY}
  fi
}

parse_options() {
  while [ "$#" -gt 0 ]; do
    case "$1" in
      -h|--help)
        usage
        exit 0
        ;;
      -*)
        REDIS_OPTIONS="${REDIS_OPTIONS} $1"
        shift
        ;;
      *)
        break 2
        ;;
    esac
  done

  PROJECT="$1"
  shift
  QUERY="$*"
}

validate_options() {
  if [ -z "${PROJECT}" ]; then
    error 'missing project'
  fi

  ENV_PATH="${ENV_DIR_PATH}/${PROJECT}"

  if [ ! -f "${ENV_PATH}" ]; then
    error 'invalid project'
  fi
}

init_variables
parse_options "$@"
validate_options

run_redis
