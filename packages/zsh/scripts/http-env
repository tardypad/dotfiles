#!/bin/sh

init_variables() {
  COMMAND=${0##*/}

  ENV_DIR_PATH="${XDG_DATA_HOME:-$HOME/.local/share}/env/http"

  HTTP_OPTIONS=
  PROJECT=
  ENVIRONMENT=
  REQUEST_METHOD=
  REQUEST_PATH=
  REQUEST_ITEMS=

  ENV_PATH=
}

usage() {
  cat <<- EOF
	usage: ${COMMAND} [<options>] project environment request_method request_path [<request_items>] [ -- <http options> ]

	Run a HTTP request to a project environment

	Options:
	  -h    show this message only
	EOF
}

error() {
  [ -z "$1" ] || echo "${COMMAND}: $1"
  echo "Try '${COMMAND} -h' for more information."
  exit 1
} >&2

run_http() {
  URL="$( head -n 1 "${ENV_PATH}" )/${REQUEST_PATH}"

  OPTIONS=$( grep '^-' "${ENV_PATH}" | tr '\n' ' ' )
  OPTIONS="${OPTIONS} ${HTTP_OPTIONS}"

  ITEMS=$( tail -n +2 "${ENV_PATH}" | grep -v '^-' | tr '\n' ' ' )
  ITEMS="${ITEMS} ${REQUEST_ITEMS}"

  http ${OPTIONS} "${REQUEST_METHOD}" "${URL}" ${ITEMS}
}

parse_options() {
  while getopts h OPT; do
    case "${OPT}" in
      h) usage; exit 0 ;;
      ?) error ;;
    esac
  done

  shift $(( OPTIND - 1 ))

  PROJECT="$1"
  ENVIRONMENT="$2"
  REQUEST_METHOD="$3"
  REQUEST_PATH="$4"
  shift 4 2> /dev/null

  while [ "$#" -gt 0 ] && [ "$1" != '--' ]; do
    REQUEST_ITEMS="${REQUEST_ITEMS} $1"
    shift
  done

  shift 2> /dev/null
  HTTP_OPTIONS="$*"
}

validate_options() {
  if [ -z "${PROJECT}" ]; then
    error 'missing project'
  fi

  if [ -z "${ENVIRONMENT}" ]; then
    error 'missing environment'
  fi

  if [ -z "${REQUEST_METHOD}" ]; then
    error 'missing request method'
  fi

  if [ -z "${REQUEST_PATH}" ]; then
    error 'missing request path'
  fi

  ENV_PATH="${ENV_DIR_PATH}/${PROJECT}/${ENVIRONMENT}"

  if [ ! -f "${ENV_PATH}" ]; then
    error 'invalid project/environment'
  fi
}

init_variables
parse_options "$@"
validate_options

run_http
