#!/bin/sh

init_variables() {
  COMMAND=$0

  LIST_LENGTH=10
  NEWS_FILE=$( mktemp )
  ITEM_INDEX=
}

trap 'rm -f "${NEWS_FILE}"' EXIT

usage() {
  cat <<- EOF
	usage: ${COMMAND} [<options>] [<index>]

	Display Arch Linux News feed
	without index argument, displays summary list
	with index argument, displays full item content

	Options:
	  -h,  --help      show this message only
	EOF
}

error() {
  [ -z "$1" ] || echo "${COMMAND}: $1"
  echo "Try '${COMMAND} --help' for more information."
  exit 1
} >&2

fetch_news_feed() {
  if ! curl -s -L 'https://www.archlinux.org/feeds/news/' \
       -o "${NEWS_FILE}"; then
   error 'fail fetching feed'
  fi
}

news_item_date() {
  index="$1"

  xmllint --xpath "/rss/channel/item[${index}]/pubDate" "${NEWS_FILE}" \
    | sed 's|<pubDate>\(.*\)</pubDate>|\1|' \
    | date +'%Y-%m-%d' -f -
} 2> /dev/null

news_item_title() {
  index="$1"

  xmllint --xpath "/rss/channel/item[${index}]/title" "${NEWS_FILE}" \
    | sed 's/&lt;/</g' \
    | sed 's/&gt;/>/g' \
    | sed 's|<title> *\(.*\) *</title>|\1|'
} 2> /dev/null

news_item_description() {
  index="$1"

  xmllint --xpath "/rss/channel/item[${index}]/description" "${NEWS_FILE}" \
    | sed 's/&lt;/</g' \
    | sed 's/&gt;/>/g' \
    | elinks -dump
} 2> /dev/null

news_items_list() {
  for i in $( seq 1 "${LIST_LENGTH}" ); do
    printf "%2s  $( tput setaf {color/base0A/number} )%s$( tput sgr0 )  %s\n" \
      "$i" \
      "$( news_item_date "$i" )" \
      "$( news_item_title "$i" )"
  done
}

news_item_full() {
  index="$1"

  tput setaf {color/base0A/number}; news_item_date "${index}"
  tput setaf {color/base0B/number}; news_item_title "${index}"
  tput sgr0; printf '\n'
  news_item_description "${index}"
}

arch_news() {
 fetch_news_feed

 if [ -z "${ITEM_INDEX}" ]; then
   news_items_list
 else
   news_item_full "${ITEM_INDEX}"
 fi
}

parse_options() {
  while [ "$#" -gt 0 ]; do
    case "$1" in
      -h|--help)
        usage
        exit 0
        ;;
      *)
        break 2
        ;;
    esac
  done

  ITEM_INDEX="$1"
}

init_variables
parse_options "$@"

arch_news
