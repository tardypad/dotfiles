#!/bin/sh

init_variables() {
  COMMAND=${0##*/}

  PACKAGE_NAME=
}

usage() {
  cat <<- EOF
	usage: ${COMMAND} [<options>] package

	Display a diff of a package modified files

	Options:
	  -h,  --help    show this message only
	EOF
}

error() {
  [ -z "$1" ] || echo "${COMMAND}: $1"
  echo "Try '${COMMAND} --help' for more information."
  exit 1
} >&2

diff_package() {
  PACKAGE_VERSION=$(
    pacman -Q "${PACKAGE_NAME}" 2> /dev/null \
      | cut -f 2 -d ' '
  )

  # need double -k argument to show modified files
  pacman -Qkk "${PACKAGE_NAME}" \
   | grep '^backup file:' \
   | cut -f 4 -d ' ' \
   | uniq \
   | while read -r PACKAGE_MODIFIED_FILE; do
       echo "${PACKAGE_MODIFIED_FILE}"
       tar -xO \
         -f "/var/cache/pacman/pkg/${PACKAGE_NAME}-${PACKAGE_VERSION}"-*.pkg.tar.xz \
         "$( echo "${PACKAGE_MODIFIED_FILE}" | sed 's|/||' )" \
         2> /dev/null \
       | diff - "${PACKAGE_MODIFIED_FILE}"
       echo
     done
}

parse_options() {
  while [ "$#" -gt 0 ]; do
    case "$1" in
      -h|--help)
        usage
        exit 0
        ;;
      *)
        break 2
        ;;
    esac
  done

  PACKAGE_NAME="$1"
}

validate_options() {
  if [ -z "${PACKAGE_NAME}" ]; then
    error 'missing package name'
  fi

  if ! pacman -Q "${PACKAGE_NAME}" > /dev/null 2>&1; then
    error "invalid package name ${PACKAGE_NAME}"
  fi
}

init_variables
parse_options "$@"
validate_options

diff_package
