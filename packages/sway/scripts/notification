#! /usr/bin/env zsh

TITLE="$1"
TMP_TEXT_FILE="$2"

WINDOW_TITLE="sway_notification_$( echo "${TITLE}" | tr 'A-Z ' 'a-z_' )"

# do nothing if the "Do not disturb" mode is on
# or if there is already a similar notification
# or if the lockscreen is on
# #HACK: there is a bug that floating windows are visible atop the lockscreen
#       so we prevent the display in that case
if pgrep swaylock &> /dev/null \
  || swaymsg -t get_tree | grep --quiet "${WINDOW_TITLE}" \
  || [[ $( do_not_disturb status ) == 'enabled' ]]; then
  rm "${TMP_TEXT_FILE}"
  exit
fi

# #HACK: need to set termite size at start,
# also present in sway rules, to have it respected
COMMAND="\
  termite \
    --exec 'sh -c \"display_notification \\\"${TITLE}\\\" ${TMP_TEXT_FILE}\"' \
    --config ${HOME}/.config/termite/config_notification \
    --title ${WINDOW_TITLE} \
    --geometry 500X300 \
  && rm \"${TMP_TEXT_FILE}\"\
"

swaymsg -t command exec "${COMMAND}"
