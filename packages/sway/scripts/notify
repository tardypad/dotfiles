#!/bin/sh

init_variables() {
  COMMAND=${0##*/}

  SUMMARY=
  BODY=
  CATEGORY=
  EXPIRE_TIME=0
  HINTS='{}'
  IDENTIFIER=

  # unused as parameters
  APP_NAME=
  REPLACE_ID=0
  ICON=
  ACTIONS='[]'
}

usage() {
  cat <<- EOF
	usage: ${COMMAND} [<options>] summary [body]

	Send a notification

	Options:
	  -c  CATEGORY  notification category
	  -h            show this message only
	  -i  ID        notification identifier
	                replace similar notification if any
	  -t  TIME      timeout in seconds
	EOF
}

error() {
  [ -z "$1" ] || echo "${COMMAND}: $1"
  printf "Try '%s -h' for more information.\n" "${COMMAND}"
  exit 1
} >&2

send_notification() {
  if [ -n "${CATEGORY}" ]; then
    HINTS="{\"category\":<string \"${CATEGORY}\">}"
  fi

  if [ -n "${IDENTIFIER}" ]; then
    NOTIFICATION_FILE="${XDG_RUNTIME_DIR}/notification_${IDENTIFIER}"
    if [ -f "${NOTIFICATION_FILE}" ]; then
      REPLACE_ID=$( cat "${NOTIFICATION_FILE}" )
    fi
  fi

  NOTIFICATION_ID=$(
    gdbus call \
      --session \
      --dest org.freedesktop.Notifications \
      --object-path /org/freedesktop/Notifications \
      --method org.freedesktop.Notifications.Notify \
      "${APP_NAME}" \
      "${REPLACE_ID}" \
      "${ICON}" \
      "${SUMMARY}" \
      "${BODY}" \
      "${ACTIONS}" \
      "${HINTS}" \
      "int32 $(( EXPIRE_TIME * 1000 ))" \
    | sed 's/(uint32 \([0-9]*\),)/\1/'
  )

  if [ -n "${IDENTIFIER}" ]; then
    echo "${NOTIFICATION_ID}" > "${NOTIFICATION_FILE}"
  fi
}

parse_options() {
  while getopts c:hi:t: OPT; do
    case "${OPT}" in
      c) CATEGORY="${OPTARG}" ;;
      h) usage; exit 0 ;;
      i) IDENTIFIER="${OPTARG}" ;;
      t) EXPIRE_TIME="${OPTARG}" ;;
      ?) error ;;
    esac
  done

  shift $(( OPTIND - 1 ))

  SUMMARY="$1"
  BODY="$2"
}

validate_options() {
  if [ -z "${SUMMARY}" ]; then
    error 'missing summary argument'
  fi

  if ! echo "${EXPIRE_TIME}" | grep -E -q '^[0-9]*$'; then
    error 'expire time must be a number'
  fi
}

init_variables
parse_options "$@"
validate_options

send_notification
