#!/bin/sh
# commands used:
# - git

init_variables() {
  COMMAND=${0##*/}

  REPLACE=false
  unset ID
  unset MSG
}

parse_command_line() {
  while getopts r OPT; do
    case "${OPT}" in
      r) REPLACE=true ;;
      ?) exit_error ;;
    esac
  done

  shift $(( OPTIND - 1 ))

  ID="$1"
  MSG="$2"
}

validate_command_line() {
  # ID should be set to non-empty string
  if [ -z "${ID}" ]; then
    exit_error "missing stamp identifier"
  fi
}

exit_error() {
  [ -z "$1" ] || echo "${COMMAND}: $1"
  exit 1
} >&2

stamp() {
  COMMIT_MSG=$( git log -1 --pretty=%B )
  [ -n "${MSG}" ] && STAMP_MSG="${ID} ${MSG}" || STAMP_MSG="${ID}"

  if [ "${REPLACE}" = 'true' ]; then
    # remove previous stamps with same ID from the commit message
    COMMIT_MSG=$(
      echo "${COMMIT_MSG}" \
        | grep -i -v "^${ID}" \
        | sed -e '/^$/N' -e '/^\n$/D'
    )
  fi

  # append the stamp to the commit message in a new paragraph
  git commit --amend \
    -m "${COMMIT_MSG}" \
    -m "${STAMP_MSG}" \
    > /dev/null

  # show result
  git log -1 --pretty=full
}

init_variables
parse_command_line "$@"
validate_command_line

stamp
