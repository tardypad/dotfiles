#!/bin/sh
# commands used:
# - git

init_variables() {
  COMMAND=${0##*/}
  GIT_COMMAND=${COMMAND#*-}

  TMP_FILE=$( mktemp )
  trap 'rm "${TMP_FILE}"' EXIT

  SCRIPT=
}

usage() {
  cat <<- EOF
	usage: git ${GIT_COMMAND} [<options>] <script>

	Apply a sed script over all text files managed by git

	Options:
	    -h               show this message only
	EOF
}

error() {
  [ -z "$1" ] || echo "${COMMAND}: $1"
  echo "Try 'git ${GIT_COMMAND} -h' for more information."
  exit 1
} >&2

run_sed() {
  # exclude symlinks and binary files
  git grep -I -l '' \
    | xargs -I {} \
      sh -c "sed \"${SCRIPT}\" {} > \"${TMP_FILE}\" \
             && cp \"${TMP_FILE}\" {}"
}

parse_options() {
  while getopts h OPT; do
    case "${OPT}" in
      h) usage; exit 0 ;;
      ?) error ;;
    esac
  done

  shift $(( OPTIND - 1 ))

  SCRIPT="$*"
}

validate_options() {
  if [ -z "${SCRIPT}" ]; then
    error "missing sed script argument"
  fi
}

init_variables
parse_options "$@"
validate_options

run_sed
