#!/usr/bin/env bash


init_variables() {
  COMMAND=${0##*/}
  GIT_COMMAND=${COMMAND#*-}

  SCRIPT=
}


usage() {
  cat <<- EOF
	usage: git ${GIT_COMMAND} [<options>] <script>

	Apply a sed script over all text files managed by git

	Options:
	    -h               show this message only
	EOF
}


error() {
  [[ -z "$1" ]] || echo "${COMMAND}: $1"
  echo "Try 'git ${GIT_COMMAND} -h' for more information."
  exit 1
} >&2


run_sed() {
  # exclude symlinks and binary files
  git grep -I --name-only '' \
    | xargs sed --in-place "${SCRIPT}"
}


parse_options() {
  while [[ "$#" -gt 0 ]]; do
    case "$1" in
      -h)
        usage
        exit 0
        ;;
      *)
        break
        ;;
    esac
  done

  SCRIPT="$@"
}


validate_options() {
  if [[ -z "${SCRIPT}" ]]; then
    error "missing sed script argument"
  fi
}


init_variables
parse_options "$@"
validate_options

run_sed
