#!/bin/sh
# commands used:
# - column
# - pacman

init_variables() {
  COMMAND=${0##*/}

  ONLY_DIFF=0
}

show_usage() {
  cat <<- EOF
	usage: ${COMMAND} [<options>]

	Check and report packages versions:
	- version installed on the system
	- version listed in the READMEs

	Needs to be run from the repository root

	Options:
	  -d    only list packages where versions are different
	  -h    show this message only
	EOF
}

parse_command_line() {
  while getopts dh OPT; do
    case "${OPT}" in
      d) ONLY_DIFF=1 ;;
      h) show_usage; exit 0 ;;
      ?) exit_error ;;
    esac
  done

  shift $(( OPTIND - 1 ))
}

exit_error() {
  [ -z "$1" ] || echo "${COMMAND}: $1"
  echo "Try '${COMMAND} -h' for more information."
  exit 1
} >&2

readme_version() {
  TYPE="$1"
  ITEM="$2"

  case "${TYPE}" in
    main)
      sed -n "s#^| \[${ITEM}\].*| \[\(.*\)\].*#\1#p" README.md
      ;;
    extra)
      sed -n "s#^| ${ITEM} .*| \[\(.*\)\].*#\1#p" README.md
      ;;
    extension)
      sed -n "s#^| ${ITEM} .*| \[\(.*\)\].*#\1#p" files/configs/*/README.md
      ;;
  esac
}

pacman_version() {
  PACKAGE="$1"

  [ "${PACKAGE}" = 'gron' ] && PACKAGE='gron-bin'

  PACMAN_INFO=$(
    pacman -Qi "${PACKAGE}" 2> /dev/null
  )

  if [ -z "${PACMAN_INFO}" ]; then
    # try with -git suffix if package couldn't be found
    PACMAN_INFO=$(
      pacman -Qi "${PACKAGE}-git" 2> /dev/null
    )
  fi

  if [ -z "${PACMAN_INFO}" ]; then
    echo 'unknown'
    return
  fi

  # extract version without the release number
  echo "${PACMAN_INFO}" \
    | sed -n 's/^Version *: \(.*\)\-[0-9]*/\1/p'
}

report() {
  TYPE="$1"

  while read -r ITEM; do
    VERSION1=$( pacman_version "${ITEM}" )
    VERSION2=$( readme_version "${TYPE}" "${ITEM}" )

    if [ "${ONLY_DIFF}" -eq 1 ] \
       && [ "${VERSION1}" = "${VERSION2}" ]; then
      continue
    fi

    printf '%s %s %s\n' \
      "${ITEM}" \
      "${VERSION1}" \
      "${VERSION2}"
  done
}

report_all() {
  {
    # main packages
    sed -n 's#^| \[\([^ ]*\)\].*#\1#p' README.md \
      | report main

    # extra packages
    sed -n 's#^| \([a-z][^ ]*\) .*#\1#p' README.md \
      | report extra

    # extensions
    # exclude vim and weechat plugins (not managed by package manager)
    find files/configs/* -type f -name README.md \
      ! -path '*/vim/*' ! -path '*/weechat/*' \
      -exec sed -n 's#^| \([a-z][^ ]*\) .*#\1#p' {} \; \
      | report extension
  } \
    | sort \
    | column -t
}

init_variables
parse_command_line "$@"

report_all
