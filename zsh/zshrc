# load all individual configs with their possible
# local extension/override immediately afterwards
function load_conf() {
  local local_conf
  for conf in "${HOME}/.zsh/conf/"*[^.local].zsh; do
    source "${conf}"

    local_conf="${conf%.*}.local.zsh"
    if [[ -f "${local_conf}" ]]; then
      source "${local_conf}"
    fi
  done
}

load_conf

unset -f load_conf

eval $( dircolors "${HOME}/.dircolors" )

# enable changing directories without typing cd
setopt auto_cd

# Disable flow control (Ctrl-q/Ctrl-s)
setopt no_flow_control
# setopt doesn't seem to be enough when using vim within tmux...
stty -ixon

# reuse ssh-agent across ttys
ssh-add -l &>/dev/null
if [ "$?" -eq 2 ]; then
  test -r ~/.cache/ssh-agent && \
  eval "$(<~/.cache/ssh-agent)" >/dev/null

  ssh-add -l &>/dev/null
  if [ "$?" -eq 2 ]; then
    (umask 066; ssh-agent > ~/.cache/ssh-agent)
    eval "$(<~/.cache/ssh-agent)" >/dev/null
  fi
fi

# reload config on interactive shell
# when catching user defined signal USR1
TRAPUSR1() {
  if [[ -o INTERACTIVE ]]; then
    source "${HOME}/.zshrc"
  fi
}

### Fish-like autosuggestions

source /usr/share/zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh
export ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE=fg=10

# Ctrl+Enter accepts and executes suggestion
bindkey '^[[27;5;13~' autosuggest-execute
bindkey -M vicmd '^[[27;5;13~' autosuggest-execute

# only accept line with EOL widgets
export ZSH_AUTOSUGGEST_ACCEPT_WIDGETS=(
  vi-end-of-line
  vi-add-eol
)

### Syntax highlighting

# important to source the syntax highlighting at the end
# because it needs all widgets to be already created
source /usr/share/zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh

# define all highlighters
export ZSH_HIGHLIGHT_HIGHLIGHTERS=(
  main
  brackets
  pattern
)

# highlight potentially dangerous commands that requires extra attention
export ZSH_HIGHLIGHT_PATTERNS=('rm -(rf|fr) *' 'bg=red,fg=black,bold')

# brackets matching colors
export ZSH_HIGHLIGHT_STYLES[bracket-error]='fg=red,bold'
export ZSH_HIGHLIGHT_STYLES[cursor-matchingbracket]='fg=white,bold'
export ZSH_HIGHLIGHT_STYLES[bracket-level-1]='fg=green'
export ZSH_HIGHLIGHT_STYLES[bracket-level-2]='fg=cyan'
export ZSH_HIGHLIGHT_STYLES[bracket-level-3]='fg=blue'
export ZSH_HIGHLIGHT_STYLES[bracket-level-4]='fg=yellow'
export ZSH_HIGHLIGHT_STYLES[bracket-level-5]='fg=magenta'

### Fish-like history substring search

# important to source the history substring search after syntax highlighting
source /usr/share/zsh/plugins/zsh-history-substring-search/zsh-history-substring-search.zsh

# substring history navigation
bindkey -M vicmd 'k' history-substring-search-up
bindkey -M vicmd 'j' history-substring-search-down

# colors
export HISTORY_SUBSTRING_SEARCH_HIGHLIGHT_FOUND='bg=magenta,fg=black'
export HISTORY_SUBSTRING_SEARCH_HIGHLIGHT_NOT_FOUND='bg=red,fg=black'
